# UDPlex 负载均衡组件

## 功能概述
- 实时流量统计和监控
- 根据流量大小和负载策略智能分发数据包
- 支持多种负载均衡算法
- 动态调整转发策略
- 支持权重配置

## 流量统计机制

负载均衡组件使用滑动窗口机制进行流量统计：

1. **采样机制**：每隔 1s 时间间隔，将当前累积的流量数据作为一个样本存储
2. **窗口大小**：滑动窗口保存 `window_size` 个样本
3. **统计计算**：`bps` 和 `pps` 值为窗口内所有样本的平均值
4. **实时更新**：数据包到达时实时累加到当前样本，规则评估时计算平均值

**示例**：
- `window_size: 10` 
- 窗口保存10个样本，每个样本代表1秒的流量统计
- `bps` 和 `pps` 为过去10秒的平均每秒字节数和包数

## 配置参数

### load_balancer 组件参数
| 参数 | 说明                             |
|------|--------------------------------|
| `type` | 组件类型: `load_balancer`，表示负载均衡组件 |
| `tag` | 组件唯一标识，用于在detour中引用            |
| `detour` | 转发路径，指定接收数据的组件标识列表             |
| `window_size` | 流量统计时间窗口，如10，代表10s             |


### detour配置
| 参数       | 说明              |
|----------|-----------------|
| `rule`   | 转发规则，详情参考`匹配规则` |
| `target` | 转发目标tag，数组，可多个  |


## 匹配规则

+ 内置变量

| 变量名 | 说明                                   |
|--------|----------------------------------------|
| `seq`  | 流量包序列号                           |
| `bps`  | 在统计窗口内的字节数                   |
| `pps`  | 在统计窗口内的数据包数                 |

+ 支持的运算表达式

匹配规则支持灵活的运算表达式，最终运算表达式的结果只要不等于零，就表示匹配成立（即条件成立）。你可以使用各种运算符和条件组合，例如：

- 比较运算：`==`, `!=`, `<`, `<=`, `>`, `>=`
- 逻辑运算：`&&`（与）, `||`（或）, `!`（非）
- 模运算：`%`（取模，用于实现轮询、负载均衡）
- 其他表达式：可结合括号 `()` 使用，增强表达式的复杂性

### 流量均衡示例

利用模运算实现基础的流量均衡策略，例如：

- 使用`$seq % 2 == 0`和`$seq % 2 == 1`实现按奇偶轮流处理，达到流量均衡效果。
- 结合逻辑运算，构建更复杂的分发策略，例如：

```
($seq % 2 == 0) || ($pps > 1000)
```


表示当包序列号为偶数，或在统计窗口内的数据包数超过1000时，条件成立。

### 示例规则格式

```
# 仅处理包序列号为奇数或包大小超过100字节的流量
($seq % 2 == 1) || ($bps > 100)
```


**注意事项：**
- 运算表达式最后的结果只要不等于0，即为条件成立。
- 你可以结合多种运算符和内置变量，灵活定义流量匹配规则。
- 规则中的变量（如`$seq`, `$bps`, `$pps`）应在配置中正确声明和使用。

## 配置示例

以下是一个完整的负载均衡配置示例，展示如何在三个服务器之间进行流量分发：

```json
{
    "services": [
        {
            "type": "listen",
            "tag": "client_listen",
            "listen_addr": "0.0.0.0:5202",
            "timeout": 120,
            "detour": ["load_balancer"]
        },
        {
            "type": "load_balancer",
            "tag": "load_balancer",
            "sample_interval": "1s",
            "window_size": 10,
            "detour": [
                {
                    "rule": "$seq % 3 == 0",
                    "target": ["server1"]
                },
                {
                    "rule": "$seq % 3 == 1", 
                    "target": ["server2"]
                },
                {
                    "rule": "$seq % 3 == 2 || $pps > 1000",
                    "target": ["server3"]
                }
            ]
        },
        {
            "type": "forward",
            "tag": "server1",
            "forwarders": ["192.168.1.10:5201"],
            "detour": ["client_listen"]
        },
        {
            "type": "forward", 
            "tag": "server2",
            "forwarders": ["192.168.1.11:5201"],
            "detour": ["client_listen"]
        },
        {
            "type": "forward",
            "tag": "server3", 
            "forwarders": ["192.168.1.12:5201"],
            "detour": ["client_listen"]
        }
    ]
}
```

### 规则说明

上述配置实现了以下负载均衡策略：

1. **轮询分发**：基于包序列号进行取模运算，实现基础的轮询负载均衡
   - `$seq % 3 == 0`：每3个包中的第1个发往server1
   - `$seq % 3 == 1`：每3个包中的第2个发往server2
   - `$seq % 3 == 2`：每3个包中的第3个发往server3

2. **高负载保护**：当PPS超过1000时，额外的流量会被路由到server3
   - `$pps > 1000`：当统计窗口内的包数超过1000时条件成立

3. **统计窗口配置**：
   - `sample_interval: "1s"`：每秒采样一次流量统计
   - `window_size: "10s"`：统计窗口为10秒，每10秒重置统计数据